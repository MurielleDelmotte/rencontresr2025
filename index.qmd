---
title: "Truffles : une application Shiny pour cultiver ses donnÃ©esâ€¦ et ses truffes !"
format: 
  thinkridentity-revealjs:
    embed-resources: true
author: Murielle Delmotte
date: last-modified
execute:
  echo: false
  eval: true
---

## Qui suis-je ?

- DÃ©veloppeuse R chez [ThinkR](https://thinkr.fr/)

::: {.fragment}

- Maman (Ã§a aussi c'est de la gestion de projet ğŸ˜…)

:::

::: {.fragment}

- MariÃ©e Ã  un agriculteur ğŸšœ

:::

::: {.fragment}
### Pourquoi ce projet ?
:::

::: {.columns}


::: {.column}
::: {.fragment}
Moi : 

- A la suite d'un workshop js menÃ© par un collÃ¨gue, je cherchais un cas d'application (pour me faire la main)
- Sur un sujet qui ait du sens
- Pour un projet utile et utilisÃ©
:::
:::



::: {.column}
::: {.fragment}
Mon mari : 

- qui a une plantation de **chÃªnes truffiers** ğŸŒ³
- qui commencent Ã  produire des truffes (10 ans d'attentes quand mÃªme...)
- qui tente de mieux comprendre sa rÃ©colte 
:::
:::
:::

::: {.fragment}
> Et si je faisais une application Shiny ?
:::

## DÃ©finition du besoin

::: {.columns}
::: {.column} 

> De quoi tu as besoin ? 

  - Visualiser les chÃªnes truffiers
  - Avoir l'historique des truffes par arbre
  - Identifier les arbres rÃ©ensemencÃ©s
  - Pouvoir ajouter une nouvelle truffe
  - Analyser les rendements par annÃ©es, par rÃ©ensemenÃ§age, par type
  - Accessible en **bottes** au milieu du champs

:::

::: {.column}

::: {.fragment} 

On fait une maquette ? 

![](./img/structure_app_simplify.png){width=90%}

:::
:::
:::

# Les donnÃ©es

## Nettoyage & Structuration {.nostretch}

:::: {layout="[ 55, 40 ]"}

::: {#first-column}

### ğŸ“¥ Source brute : tableur Excel (.xlsx)

- Informations imbriquÃ©es :

  - NÂ° de ligne et colonne = position physique

  - Cellule = type de plant + identifiant

  - Couleurs = mÃ©ta-informations (plante mangÃ©e, limite, etc.)

<blockquote style="font-size: 0.9em; border-left: 3px solid #ccc; padding-left: 10px; margin: 0em 0;">
_Ã‰tape : Structuration tabulaire _
</blockquote>

:::

::: {#second-column}
![](./img/chene_data_init.jpg){width=80%}
:::

::::


<div style="margin-top: 2em;"></div>

::: {.fragment} 

### GÃ©nÃ©ration du GeoJSON avec geojson.io

  - A partir de la table structurÃ©e 

  - Dessiner les points pour rÃ©cupÃ©rer des attributs lat, lon

  - Exporter le fichier .geojson

ğŸ” RÃ©sultat : Un fichier lÃ©ger, compatible avec de nombreux outils de visualisation web ou R

:::

## Mise en place d'une base de donnÃ©es relationnelle

:::: {layout="[ 50, 50 ]"}

::: {#first-column}

### ğŸ§± Structure relationnelle :

- `chenes` : coordonnÃ©es GPS et mÃ©tadonnÃ©es de chaque chÃªne

- `truffe` : truffes trouvÃ©es au pied dâ€™un chÃªne

- `reens` : historique des rÃ©ensemencement (remise en culture)

<div style="margin-top: 1em;"></div>

### ğŸ”— Relations clÃ©s :

- chenes.idoak est la clÃ© primaire (identifiant du chÃªne)

- truffe.idoak et reens.idoak : clÃ©s Ã©trangÃ¨res vers chenes

:::

::: {#second-column}
![](./img/schema_EA.png){width=100%}
:::
::::


## IntÃ©gration dans [Supabase](https://supabase.com) 

:::: {layout="[ 40, 60 ]"}

::: {#first-column}

âœ… Avantages

- Simple de prise en main

- Open source ou auto-hÃ©bergeable

- Interface web moderne (SQL, rÃ´les, tables)

- API REST auto-gÃ©nÃ©rÃ©e, interrogeable en R

- Logs sur les usages de la BDD

âš ï¸ Limite

- Mise en veille auto sur lâ€™offre gratuite (inactivitÃ©)


:::

::: {#second-column}
![](./img/bdd_schema_supabase.png){width=100%}
:::
::::



# L'approche technique

## {}

### ğŸŒ Leaflet.js : Cartographie Interactives des Arbres  {.nostretch}

- **Le besoin** : Visualiser et interagir avec les chÃªnes truffier sur une carte cliquable.

- **La solution JS** : Utilisation de `Leaflet.js` pour afficher des marqueurs pour chaque arbre, avec des interactions qui permettent de rÃ©cupÃ©rer le numÃ©ro du chÃªne cliquÃ©.

::: {.fragment} 
### ğŸ„ SweetAlert2 : Pop-ups Interactifs  {.nostretch}

- **Le besoin** : Permettre aux utilisateurs d'ajouter des truffes via une interface conviviale, de visualiser les informations concernant un chÃªne truffier, ...

- **La solution JS** : IntÃ©gration de `SweetAlert2` avec des formulaire HTML dans des modales et y capturer les informations nÃ©cessaires.
:::

::: {.fragment} 
### ğŸ“Š Chart.js : Visualisation des Rendements  {.nostretch}

- **Le besoin** : Afficher des graphiques des rendements de truffes.

- **La solution JS** : Utilisation de `Chart.js` pour gÃ©nÃ©rer des graphiques interactifs basÃ©s sur les donnÃ©es de la base.
:::

## {}

### Shiny + Golem : Application R StructurÃ©e {.nostretch}

:::: {layout="[ 80, 20 ]"}

::: {#first-column}

- **Le besoin** : Disposer d'une application robuste, facilement maintenable et testable

- **La solution R** : Structuration en package `{golem}` pour sÃ©parer clairement interface, logique mÃ©tier dans des modules.
:::
::: {#second-column}
![](./img/golem.png){width=50%}
:::
::::

::: {.fragment}

### ğŸ“± shinyMobile : Interface adaptÃ©e au terrain {.nostretch}


:::: {layout="[ 80, 20 ]"}

::: {#first-column}
- **Le besoin** : Utiliser lâ€™application sur smartphone directement au pied des arbres.

- **La solution R** : Utilisation de `{shinyMobile}` pour une interface responsive, lÃ©gÃ¨re.
:::
::: {#second-column}
![](./img/hex_shinyMobile.png){width=50%}
:::
::::


:::

::: {.fragment}

> ğŸ‘‰ Un vrai mix R/JS

:::

## Fonctions mÃ©tier {.nostretch}

<img src="img/hex-truffles.png" class="img-top-right" width="80">

> Peu de fonctions, mais ciblÃ©es !

:::: {layout="[ 55, 45 ]"}

::: {#first-column}


- ğŸ“¥ **Connexion** via `{DBI}`

::: {.notes}
  - connexion Supabase via `{DBI}`
:::

- ğŸ” **Lecture et traitement de donnÃ©es**

::: {.notes}
  - rÃ©cupÃ©ration d'info ciblÃ©e par arbre, truffe, rÃ©ensemencementâ€¦
  - Calcul d'agrÃ©gation pour les graphiques

:::


- âœï¸ **Ã‰criture de donnÃ©es**  dans la BDD

::: {.notes}  
  - enregistrement dâ€™une truffe
  - ajout de rÃ©ensemencement
  - mise Ã  jour d'une truffe
:::

:::


::: {#second-column}

```r
weight_truffles_by <- function(dbtruffle, ...) {
  check_param(dbtruffle, "data.frame")
  check_names_dataframe(c("weight"), dbtruffle)

  dbtruffle |>
    group_by(...) |>
    summarise(weight = sum(weight, na.rm = TRUE), 
              .groups = "drop")
}

```
:::
::::

::: {.fragment} 
âœ… Simples, lisibles, maintenables  
âœ… MÃ©tier encapsulÃ© â†’ testable et rÃ©utilisable
:::

## Des modules golem ğŸ§©

:::: {layout="[ 55, 45 ]"}

::: {#first-column}

> Une application dÃ©coupÃ©e en briques pour plus de lisibilitÃ©


- ğŸ“¦ Utilisation des modules `{golem}` :
  - `mod_carto_leaflet.R` : carte interactive
  - `mod_dataviz.R` : visualisation des rendements

:::

::: {#second-column}

<div class="code-smaller">

```r
app_ui <- function(request) {
  tagList(
    golem_add_external_resources(),
    f7Page(
      f7TabLayout(
        navbar = f7Navbar(
          title = "Les ch\u00eanes truffiers",
          hairline = TRUE
        ),
        f7Tabs(
          animated = TRUE,
          f7Tab(
            tabName = "Carte",
            icon = f7Icon("map"),
            active = TRUE,
            f7Card(
              title = NULL,
              mod_carto_leaflet_ui("carto_leaflet_1")
            )
          ),
          f7Tab(
            tabName = "Graphe",
            icon = f7Icon("graph_square"),
            active = FALSE,
            f7Card(
              title = NULL,
              mod_dataviz_ui("dataviz_1")
            )
          )
        )
      )
    )
  )
}
```

</div>

:::
::::

## Avec un peu de magie JS âœ¨

> GrÃ¢ce Ã  `golem::invoke_js()`, je peuxâ€¦

:::: {layout="[ 55, 45 ]"}

::: {#first-column}

- Appeler du code JavaScript depuis R
- DÃ©clencher des animations ou des interactions JavaScript
- Communiquer entre R et JavaScript de maniÃ¨re fluide

:::

::: {#second-column}

<div class="code-smaller">

```r
# ...
      info <- get_info(
        dboak = global$chenes,
        dbtruffle = global$truffe,
        dbreensemence = global$reensemence,
        theidoak = input$chene_click
      )

      golem::invoke_js(
        "modal",
        list(
          id = input$chene_click,
          type = info$chene$type,
          date_reens = info$reensemence,
          date_p = as.Date(info$chene$planting_date),
          der_truf = info$truffes$last_truffle,
          tot_weight = info$truffes$weight_tot,
          last_comment = info$truffes$last_comment,
          other_comments = info$truffes$other_comments
        )
      )
# ...
```

</div>

:::
::::

## Leaflet.js : Cartographie Interactives des Arbres  {.nostretch}

:::: {layout="[ 50, 50 ]"}

::: {#first-column}

<div class="code-smaller">

Extrait js:

```js 
    for (var i = 0; i < locations.length; i++) {
      marker = new L.circleMarker([locations[i].lat, locations[i].lon])
        .unbindPopup()
        .addTo(map)
        .on("click", onClick);

      marker.id = locations[i].idoak;

      if (reens === 0) {
        if (locations[i].type === "Normal") {
          marker.setStyle({
            color: "#FF0000",
            fillColor: "#FF0000",
            fillOpacity: 1,
          });
        } else {
          marker.setStyle({
            color: "#FFA500",
            fillColor: "#FFA500",
            fillOpacity: 1,
          });
        }
      } else {
        if (locations[i].info_reens === "1") {
          marker.setStyle({
            color: "#00AEEF",
            fillColor: "#00AEEF",
            fillOpacity: 1,
          });
        } else {
          marker.setStyle({
            color: "#7f9199",
            fillColor: "#7f9199",
            fillOpacity: 1,
          });
        }
      }
    }
```

</div>

:::


::: {#second-column}

::: {style="text-align: center"}

![](./img/app_leaftlet.png){width=50%}
:::
:::

::::

## SweetAlert2 : Pop-ups Interactifs  {.nostretch}

:::: {layout="[ 50, 50 ]"}

::: {#first-column}

Extrait js:

<div class="code-smaller">

```js 
document.getElementById("identity").addEventListener("click", 
  () => {
  var filledtemplateidentitycard = fillTemplate(
    templateidentitycard,
    arg
  );

  Swal.fire({
    title: "Carte d identitÃ© du chÃªne",
    html: filledtemplateidentitycard,
    showCancelButton: false,
    confirmButtonText: `Fermer`,
  }).then((result) => {
      Shiny.setInputValue("chene_click", 
                          null, 
                          { priority: "event" });
      openMainSwal(cheneId);
     });
});
```

</div>

:::

::: {#second-column}
Exemple template HTML :

<div class="code-smaller">
```html
<b>Identifiant : </b> {{id}}
<hr> <b>Date de plantation : </b> {{date_p}}
<hr> <b>Type : </b> {{type}}
<hr> <b>Dernier RÃ©ensemencement : </b> {{date_reens}}
<hr> <b>DerniÃ¨re truffe : </b> {{der_truf}}
<hr> <b>Poids total trouvÃ© : </b> {{tot_weight}} g
<hr> <b>Dernier Commentaire : </b> {{last_comment}}
<hr> 
<details>
  <summary><b>Autres Commentaires :</b></summary>
  {{other_comments}}
</details>
```
</div>

::: {style="text-align: center"}
![](./img/identity_card.png){width=50%}
:::

:::

::::



## Chart.js : Visualisation des Rendements  {.nostretch}

:::: {layout="[ 50, 50 ]"}

::: {#first-column}

<div class="code-smaller">

Extrait js:
```js
Shiny.addCustomMessageHandler('byyear', function(arg) {

if (newChart) newChart.destroy();

const ctx = document.getElementById(arg.id);

newChart =  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: arg.labels,
      datasets: [{
        label: arg.label,
        data: arg.data,
        borderWidth: 1
      }]
    },
    options: {
      aspectRatio: 1.1, 
          responsive: true,
          plugins: {
            title: {
              display: true, 
              text: arg.title
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
    }
  });
  })
```

</div>

:::

::: {#second-column}

::: {style="text-align: center"}

![](./img/app_chartjs.png){width=50%}
:::
:::

::::




## ğŸš€ DÃ©ploiement auto sur Connect


- ğŸ“ Code source sur GitHub : <https://github.com/ThinkR-open/truffles/>
  - 2 branches principales : 
    - dev : recette (sur des donnÃ©es fictives)
    - main : production (sur les donnÃ©es clients)


::: {.fragment} 
- ğŸ“Œ Pas de Github Action pour le dÃ©ploiement de l'application

- ğŸ“¥ DÃ©ploiement depuis Posit Connect :

  - rÃ©cupÃ¨re le nouveau code depuis Github

  - reconstruit lâ€™environnement

  - dÃ©ploie automatiquement la nouvelle version
:::


::: {.fragment} 
- Un CI/CD pour : 
  - Check multi-plateforme
  - DÃ©ploiement de la documentation `{pkgdown}`
  - PrÃ©vention de lâ€™inactivitÃ© de la base via connexion rÃ©guliÃ¨re
:::

# Demo

<https://connect.thinkr.fr/trufflesdemo/>

## {.nostretch}

::: {style="text-align: center"}
![](./img/demo_truffles.gif){width=30%}
:::

::: {.notes}
Demo : 1 minute 50
:::


# Et le Client ...

## {}
### Les retours 

âš™ï¸ FacilitÃ© d'utilisation
<blockquote style="font-size: 0.9em; border-left: 3px solid #ccc; padding-left: 10px; margin: 0.5em 0;">
âœ… _"Ok Ã§a va, jâ€™ai compris comment Ã§a marche, c'est simple !"_
</blockquote>

ğŸ—ºï¸ VisibilitÃ© des donnÃ©es

<blockquote style="font-size: 0.9em; border-left: 3px solid #ccc; padding-left: 10px; margin: 0.5em 0;">
âœ… _"C'est pratique de voir direct quel arbre a donnÃ© quoi"_
</blockquote>

<div style="margin-top: 2em;"></div>

::: {.fragment} 

### Petites amÃ©liorations demandÃ©es et corrigÃ©es :

  ğŸ‘† Points un peu petits sur mobile 

  ğŸ” Un switchInput Ã  dÃ©placer pour plus d'ergonomie

  ğŸ’¬ Les commentaires : 
  <blockquote style="font-size: 0.9em; border-left: 3px solid #ccc; padding-left: 10px; margin: 0.5em 0;">
  _"Finalement, je veux surtout voir le dernier commentaire"_
</blockquote>

  ğŸšª Les modales : 
<blockquote style="font-size: 0.9em; border-left: 3px solid #ccc; padding-left: 10px; margin: 0.5em 0;">
  _"Ce serait bien de pouvoir passer de la carte d'identitÃ© Ã  la dÃ©claration d'une truffe sans Ãªtre obligÃ© de recliquer sur l'arbre"_
</blockquote>
:::



## {}

### ğŸŒ³ Cultiver ses donnÃ©esâ€¦ et ses idÃ©es

- Cette application est nÃ©e dâ€™un besoin concret, sur le terrain et dâ€™un dÃ©sir dâ€™apprendre.

- Elle mâ€™a permis de :

  - ğŸ’¡ Mettre en application et Approfondir mes compÃ©tences en JS.

  - ğŸ¤ Collaborer Ã©troitement avec un utilisateur finalâ€¦ mon mari !

  - ğŸŒ± CrÃ©er un outil simple, utile et utilisÃ©.


<div style="margin-top: 1em;"></div>

::: {.fragment} 

### ğŸš€ Et la suite ?

- Phase de test terrain cet hiver : boue, froidâ€¦ et truffes !

<blockquote style="font-size: 0.9em; border-left: 3px solid #ccc; padding-left: 10px; margin: 0em 0;">
_La vraie vie commenceâ€¦ Ã  la prochaine rÃ©colte_
</blockquote>


- AmÃ©liorations prÃ©vues :

  - ğŸ“ IntÃ©gration de la gÃ©olocalisation.

  - ğŸ” Mieux contrÃ´ler/sÃ©curiser les inputs

  - ğŸ” Gestion des utilisateurs et des droits d'accÃ¨s.

  - ğŸ§ª Aller plus loin dans les tests automatisÃ©s avec {playwright}.

:::

# Merci ! 

murielle@thinkr.fr

::: {style="text-align: center;"}
![](./img/truffes.jpg){width=60%}

<span style="font-size: 0.6em;">Â© Trufficulteurs Beauce-Val de Loire
</span>

:::

